name: Update Kombiniere CSVs zu Parquet

on:
  push:
    branches:
      - miv_parquet
  schedule:
    - cron:  '0 6 * * *' # 06:00 UTC
  workflow_dispatch:

jobs:
  update_data_py:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment: integration

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        
      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Install requirements
        run: uv pip install -r automation/automation-requirements.txt
        env:
          UV_SYSTEM_PYTHON: 1
  
      - name: Combine csv to parquet
        run: |
            python automation/combine_csv_to_parquet/build_parquet.py

      - name: Upload files to CKAN
        env:
          CKAN_BASE_URL: ${{ secrets.CKAN_BASE_URL }}
          CKAN_API_KEY: ${{ secrets.CKAN_API_KEY }}
          SSL_VERIFY: ${{ secrets.SSL_VERIFY }}
        run: |
          python automation/upload_resource_to_ckan_with_patch.py -f sid_dav_verkehrszaehlung_miv_OD2031_alle_jahre.parquet -d int_dwh_sid_dav_verkehrszaehlung_miv_od2031
          python automation/upload_resource_to_ckan_with_patch.py -f verkehrszaehlungen_werte_fussgaenger_velo_alle_jahre.parquet -d int_dwh_ted_taz_verkehrszaehlungen_werte_fussgaenger_velo

      - name: Notify telegram failure
        if: ${{ failure()  || cancelled() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_ERROR_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ðŸ”´ [combine_csv_to_parquet Job Failed](https://github.com/opendatazurich/opendatazurich.github.io/actions/runs/${{ github.run_id }}?check_suite_focus=true)
